<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DWLR - Water Level Alert System</title>
    <link rel="stylesheet" href="./DwlrAlert.css">
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>

    <!-- Top Navigation -->
    <header>
        <div class="nav-bar">
            <h1 class="navbar-title">DWLR Water Levels</h1>
            <p class="navbar-date">Last Updated: <%= new Date().toLocaleDateString() %></p>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <h2 class="sidebar-title" style="color:black; margin-top: 40px;">Alerts</h2>

            <div class="search-map">
                <form action="/search" method="GET" class="search-form">
                    <input type="text" name="q" placeholder="Search for a location..." required>
                    <button class="search-btn" type="submit">Search</button>
                </form>                                      
            </div>
            
            <div class="alerts-container mb-3">
                <% if (anomalies && anomalies.length > 0) { %>
                    <% anomalies.forEach(dam => { %>
                        <% 
                            let alertClass = "green"; 
                            if (dam.waterLevel < 3) {
                                alertClass = "red"; 
                            } else if (dam.waterLevel < 5) {
                                alertClass = "orange"; 
                            }
                        %>
                        <button type="button" class="alert-card <%= alertClass %>" 
                            onclick="console.log('ID:', '<%= dam.id_ %>', 'State:', '<%= dam.state %>', 'Water Level:', '<%= dam.waterLevel %>', 'Max Level:', '<%= dam.maxLevel || 20 %>');
                                loadGraph('<%= dam.id %>', '<%= dam.state %>', '<%= dam.waterLevel %>', '<%= dam.maxLevel || 20 %>');
                            ">
                        
                            <div class="alert-header">
                                <h3 class="dam-name"><%= dam.state %></h3>
                                <br>
                                <% if (dam.waterLevel < 3) { %>
                                    <span class="alert-label-red">Critical</span>
                                <% } else if (dam.waterLevel < 5) { %>
                                    <span class="alert-label-orange">Low</span>
                                <% } else { %>
                                    <span class="alert-label-green">Normal</span>
                                <% } %>
                            </div>                                

                            <div class="alert-content">
                                <p class="District"><%= dam.district %></p>
                                <p class="water-level"><%= dam.waterLevel %>m</p>
                                <div class="storage-info">
                                    <span class="storage-percent">
                                        <%= ((dam.waterLevel / (dam.maxLevel || 20)) * 100).toFixed(2) %>%
                                    </span>
                                    <span class="storage-label">Storage %</span>
                                </div>
                            </div>
                        </button>
                    <% }); %>
                <% } else { %>
                    <p class="no-alerts">No anomalies detected.</p>
                <% } %>                    
            </div>
        </aside>

        <!-- Map Section -->
        <main class="map-container">
            <div id="map"></div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Ajeenkya D.Y.Patil School Of Engineering</p>
    </footer>

    <!-- Secure Map Script -->
    <script>
        fetch('/map-key')
            .then(response => response.json())
            .then(data => {
                maptilersdk.config.apiKey = data.apiKey;

                const coordinates = JSON.parse('<%- JSON.stringify(coordinates || []) %>');

                const map = new maptilersdk.Map({
                    container: 'map',
                    style: maptilersdk.MapStyle.STREETS,
                    center: coordinates.length > 0 ? [coordinates[0].lng, coordinates[0].lat] : [78.9629, 20.5937],
                    zoom: 5
                });

                coordinates.forEach(coord => {
                    if (coord.lng && coord.lat) {
                        new maptilersdk.Marker()
                            .setLngLat([coord.lng, coord.lat])
                            .addTo(map);
                    }
                });
            })
            .catch(error => console.error("Error loading map:", error));
    </script>

    <!-- Load Graph Function -->
    <script>
        function loadGraph(id, state, waterLevel, maxLevel) {
            fetch('/graph', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, state, waterLevel, maxLevel })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/graph/${id}`;
                } else {
                    alert('Failed to load graph.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>

</body>
</html>
