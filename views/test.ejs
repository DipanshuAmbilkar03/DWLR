<!DOCTYPE html>
<html lang="en">
<head>
    <title>DWLR - Water Level Alert System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Styles -->
    <link rel="stylesheet" href="./DwlrAlert.css">
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.2.0/dist/maplibre-gl.css" />
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    
    <!-- Scripts -->
    <script src="https://unpkg.com/maplibre-gl@5.2.0/dist/maplibre-gl.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>

    <style>
        body { margin: 0; padding: 0; }
        #map { top: 0; bottom: 0; width: 100%; }
        .maplibregl-popup { z-index: 2; }
    </style>
</head>

<body>

    <!-- Navigation -->
    <header>
        <div class="nav-bar">
            <h1 class="navbar-title">DWLR Water Levels</h1>
            <p class="navbar-date">Last Updated: <%= new Date().toLocaleDateString() %></p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <aside class="sidebar">
            <h2 class="sidebar-title" style="color:black; margin-top: 40px;">Alerts</h2>

            <div class="search-map">
                <form action="/search" method="GET" class="search-form">
                    <input type="text" name="q" placeholder="Search for a location..." required>
                    <button class="search-btn" type="submit">Search</button>
                </form>                                      
            </div>

            <div class="alerts-container">
                <% if (anomalies && anomalies.length > 0) { %>
                    <% anomalies.forEach(dam => { %>
                        <% let alertClass = dam.waterLevel < 3 ? "red" : (dam.waterLevel < 5 ? "orange" : "green"); %>
                        <button type="button" class="alert-card <%= alertClass %>" onclick="loadGraph('<%= dam.id %>', '<%= dam.state %>', '<%= dam.waterLevel %>', '<%= dam.maxLevel || 20 %>');">
                            <div class="alert-header">
                                <h3 class="dam-name"><%= dam.state %></h3>
                                <span class="alert-label-<%= alertClass %>">
                                    <%= dam.waterLevel < 3 ? "Critical" : (dam.waterLevel < 5 ? "Low" : "Normal") %>
                                </span>
                            </div>                                
                            <div class="alert-content">
                                <p class="District"><%= dam.district %></p>
                                <p class="water-level"><%= dam.waterLevel %>m</p>
                                <div class="storage-info">
                                    <span class="storage-percent">
                                        <%= ((dam.waterLevel / (dam.maxLevel || 20)) * 100).toFixed(2) %>%
                                    </span>
                                    <span class="storage-label">Storage %</span>
                                </div>
                            </div>
                        </button>
                    <% }); %>
                <% } else { %>
                    <p class="no-alerts">No anomalies detected.</p>
                <% } %>                    
            </div>
        </aside>

        <!-- Map Section -->
        <main class="map-container">
            <div id="map"></div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Ajeenkya D.Y.Patil School Of Engineering</p>
    </footer>

    <!-- Map & Deck.gl Integration -->
    <script>
        fetch('/map-key')
            .then(response => response.json())
            .then(data => {
                if (!data.apiKey) {
                    console.error("API Key is missing");
                    alert("Failed to load map. API key missing.");
                    return;
                }
    
                const coordinates = JSON.parse('<%- JSON.stringify(coordinates || []) %>');
    
                const map = new maplibregl.Map({
                    container: 'map',
                    style: `https://api.maptiler.com/maps/streets/style.json?key=${data.apiKey}`,
                    center: coordinates.length > 0 ? [coordinates[0].lng, coordinates[0].lat] : [78.9629, 20.5937],
                    zoom: 5,
                    scrollZoom: true
                });
    
                map.scrollZoom.enable();
                map.addControl(new maplibregl.NavigationControl(), 'top-right');
    
                coordinates.forEach(coord => {
                    if (coord.lng && coord.lat) {
                        new maplibregl.Marker()
                            .setLngLat([coord.lng, coord.lat])
                            .addTo(map);
                    }
                });
    
            })
            .catch(error => {
                console.error("Error fetching API key:", error);
                alert("Error loading map. Please try again.");
            });
    </script>
    
    

</body>
</html>
